<div class="vulnerability-container">
  <div class="vulnerability-list page">
    <div class="col-lg-4 col-xs-12 page-title">
      <span>Vulnerability Difference By Date</span>
    </div>
    <div class="filter-card">
      <mat-card appearance="outlined">
        <mat-card-header>
          <div class="row filter-header">
            <div class="col-xs-12 filter-header-title">
              <h4>Report Settings</h4>
            </div>
          </div>
        </mat-card-header>
        <mat-card-content>
          <div class="filter-content">
            <form class="filter-form" (ngSubmit)="onSubmit()">
              <div class="row report-header">
                <div class="col-xs-12 col-sm-6 col-md-3">
                  <mat-form-field appearance="fill" [formGroup]="filterForm">
                    <mat-label>Fix available</mat-label>
                    <mat-select formControlName="fixAvailable">
                      <mat-option>--</mat-option>
                      <mat-option [value]="true">Yes</mat-option>
                      <mat-option [value]="false">No</mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
                <div class="col-xs-12 col-sm-6 col-md-3">
                  <mat-form-field appearance="fill" [formGroup]="filterForm">
                    <mat-label>Severity levels</mat-label>
                    <mat-select formControlName="severityLevels"
                                multiple>
                      <mat-option *ngFor="let level of vulnerabilitySeverities"
                                  [value]="level">
                        {{level}}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>

                <div class="col-xs-6">
                  <mat-form-field class="namespace-input" appearance="fill" [formGroup]="filterForm">
                    <mat-label>Namespaces</mat-label>
                    <mat-select formControlName="namespaces"
                                multiple>
                      <mat-option *ngFor="let namespace of clusterNamespaces"
                                  [value]="namespace">
                        {{namespace}}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
                <div class="col-xs-12 col-sm-6">
                  <mat-form-field appearance="fill" [formGroup]="filterForm">
                    <mat-label>Start Date</mat-label>
                    <input matInput [matDatepicker]="startPicker" disabled formControlName="startDate">
                    <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                    <mat-datepicker #startPicker disabled="false"></mat-datepicker>
                  </mat-form-field>
                </div>
                <div class="col-xs-12 col-sm-6">
                  <mat-form-field appearance="fill" [formGroup]="filterForm">
                    <mat-label>End Date</mat-label>
                    <input matInput [matDatepicker]="endPicker" disabled formControlName="endDate">
                    <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                    <mat-datepicker #endPicker disabled="false"></mat-datepicker>
                  </mat-form-field>
                </div>
              </div>
              <div class="row filter-button">
                <div class="col-xs-6 no-padding">
                  <button [disabled]="!filtersValid"
                          class="search-button"
                          mat-raised-button
                          color="primary"
                          type="submit">Search
                  </button>
                </div>
                <div class="col-xs-6 no-padding download-button">
                  <button [disabled]="!previousRequest"
                          (click)="downloadReport()"
                          mat-raised-button
                          color="primary"
                          type="button">Download
                  </button>
                </div>
              </div>
            </form>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
    <div class="graph-card">
      <mat-card appearance="outlined">
        <mat-card-header>
          <div class="report-header row">
            <div class="col-xs-9">
              Total Vulnerabilities
            </div>
            <div class="expand-button col-xs-3" (click)="showBarChart = !showBarChart">
              <mat-icon>{{showBarChart ? 'expand_less' : 'expand_more'}}</mat-icon>
            </div>
          </div>
        </mat-card-header>
        <mat-card-content [@openClose]="showBarChart ? 'open' : 'close'">
          <div class="padding-top-10" *ngIf="barChartAttributes.results?.length === 0">
            No Data to Display
          </div>
          <div class="row graph-component" *ngIf="barChartAttributes.results?.length > 0">
            <div class="col-xs-12 graph dark-theme">
              <ngx-charts-bar-vertical-stacked
                [view]="barChartAttributes.view"
                [scheme]="barChartAttributes.colorScheme"
                [results]="barChartAttributes.results"
                [legend]="barChartAttributes.showLegend"
                [legendPosition]="barChartAttributes.legendPosition"
                [gradient]="barChartAttributes.gradient"
                [xAxis]="barChartAttributes.showXAxis"
                [yAxis]="barChartAttributes.showYAxis"
                [barPadding]="barChartAttributes.barPadding"
                [showXAxisLabel]="barChartAttributes.showXAxis"
                [showYAxisLabel]="barChartAttributes.showYAxis"
                [xAxisLabel]="barChartAttributes.xAxisLabel"
                [yAxisLabel]="barChartAttributes.yAxisLabel">
                <ng-template #tooltipTemplate let-model="model">
                  <span>Date: {{ model.date | date: 'mediumDate' }}</span>
                  <br/>
                  <span>Type: {{ model.name }}</span>
                  <br/>
                  <span>Vulnerabilities: {{ model.value }}</span>
                </ng-template>
              </ngx-charts-bar-vertical-stacked>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
    <div id="new-vulnerabilities-card" class="vulnerability-card">
      <mat-card appearance="outlined">
        <mat-card-header>
          <div class="report-header row">
            <div class="col-xs-9">
              New Vulnerabilities
            </div>
            <div class="expand-button col-xs-3" (click)="showNewVulnTable = !showNewVulnTable">
              <mat-icon>{{showNewVulnTable ? 'expand_less' : 'expand_more'}}</mat-icon>
            </div>
          </div>
        </mat-card-header>
        <mat-card-content [@openClose]="showNewVulnTable ? 'open' : 'close'">
          <div class="padding-top-10" *ngIf="!numNewVulns">
              No Vulnerabilities to display
          </div>
          <div class="vulnerability-table" *ngIf="numNewVulns">
            <div class="padding-top-10">
              <h4>
                Displaying {{newVulnDataSource.data.length}} of {{numNewVulns}} vulnerabilities
              </h4>
            </div>
            <mat-table [dataSource]="newVulnDataSource">
              <ng-container matColumnDef="image" class="column-word-break">
                <mat-header-cell *matHeaderCellDef>Image</mat-header-cell>
                <mat-cell *matCellDef="let vulnerability">{{vulnerability.image}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="imageId">
                <mat-header-cell *matHeaderCellDef>Image Id</mat-header-cell>
                <mat-cell *matCellDef="let vulnerability">{{vulnerability.imageId}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="type" class="column-word-break">
                <mat-header-cell *matHeaderCellDef>CVE</mat-header-cell>
                <mat-cell *matCellDef="let vulnerability">{{vulnerability.type}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="scannerName">
                <mat-header-cell *matHeaderCellDef>Scanner</mat-header-cell>
                <mat-cell *matCellDef="let vulnerability">{{vulnerability.scannerName}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="runningInCluster">
                <mat-header-cell *matHeaderCellDef>Running?</mat-header-cell>
                <mat-cell *matCellDef="let vulnerability">{{vulnerability.runningInCluster}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="isFixable">
                <mat-header-cell *matHeaderCellDef>Fix available?</mat-header-cell>
                <mat-cell *matCellDef="let vulnerability">{{vulnerability.isFixable}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="severity">
                <mat-header-cell *matHeaderCellDef>Severity</mat-header-cell>
                <mat-cell *matCellDef="let vulnerability">{{vulnerability.severity}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="namespaces">
                <mat-header-cell *matHeaderCellDef>Namespace(s)</mat-header-cell>
                <mat-cell *matCellDef="let vulnerability">{{vulnerability.namespaces}}</mat-cell>
              </ng-container>

              <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
              <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
            </mat-table>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
    <div id="fixed-vulnerabilities-card" class="vulnerability-card">
      <mat-card appearance="outlined">
        <mat-card-header>
          <div class="report-header row">
            <div class="col-xs-9">
              Fixed Vulnerabilities
            </div>
            <div class="expand-button col-xs-3" (click)="showFixedVulnTable = !showFixedVulnTable">
              <mat-icon>{{showFixedVulnTable ? 'expand_less' : 'expand_more'}}</mat-icon>
            </div>
          </div>
        </mat-card-header>
        <mat-card-content [@openClose]="showFixedVulnTable ? 'open' : 'close'">
          <div class="padding-top-10" *ngIf="!numFixedVulns">
            No Vulnerabilities to display
          </div>
          <div class="vulnerability-table" *ngIf="numFixedVulns">
            <div class="padding-top-10">
              <h4>
                Displaying {{fixedVulnDataSource.data.length}} of {{numFixedVulns}} vulnerabilities
              </h4>
            </div>
            <mat-table [dataSource]="fixedVulnDataSource">
              <ng-container matColumnDef="image" class="column-word-break">
                <mat-header-cell *matHeaderCellDef>Image</mat-header-cell>
                <mat-cell *matCellDef="let vulnerability">{{vulnerability.image}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="imageId">
                <mat-header-cell *matHeaderCellDef>Image Id</mat-header-cell>
                <mat-cell *matCellDef="let vulnerability">{{vulnerability.imageId}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="type" class="column-word-break">
                <mat-header-cell *matHeaderCellDef>CVE</mat-header-cell>
                <mat-cell *matCellDef="let vulnerability">{{vulnerability.type}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="scannerName">
                <mat-header-cell *matHeaderCellDef>Scanner</mat-header-cell>
                <mat-cell *matCellDef="let vulnerability">{{vulnerability.scannerName}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="runningInCluster">
                <mat-header-cell *matHeaderCellDef>Running?</mat-header-cell>
                <mat-cell *matCellDef="let vulnerability">{{vulnerability.runningInCluster}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="isFixable">
                <mat-header-cell *matHeaderCellDef>Fix available?</mat-header-cell>
                <mat-cell *matCellDef="let vulnerability">{{vulnerability.isFixable}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="severity">
                <mat-header-cell *matHeaderCellDef>Severity</mat-header-cell>
                <mat-cell *matCellDef="let vulnerability">{{vulnerability.severity}}</mat-cell>
              </ng-container>
              <ng-container matColumnDef="namespaces">
                <mat-header-cell *matHeaderCellDef>Namespace(s)</mat-header-cell>
                <mat-cell *matCellDef="let vulnerability">{{vulnerability.namespaces}}</mat-cell>
              </ng-container>

              <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
              <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
            </mat-table>
          </div>
        </mat-card-content>

      </mat-card>
    </div>
  </div>
</div>
